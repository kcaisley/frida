# FRIDA DAQ Hardware Configuration
#
# Based on:
#   - obelix1-daq/obelix1/system/DAQ.yaml
#   - CordiaADC/ADC_01/host/meas_ADC01.yaml
#
# Signal names match PCB schematic: frida/pcb/frida65A.kicad_sch
#
# Hardware setup:
#   Host PC <--Ethernet--> BDAQ-core (KX2 FPGA) <--LVDS/SPI--> FRIDA chip PCB

name: frida-daq
version: 0.1.0

transfer_layer:
  - name: intf
    type: SiTcp
    init:
      ip: "192.168.10.16"
      tcp_port: 24
      udp_port: 4660
      tcp_connection: true

hw_drivers:
  # FIFO for ADC data readback
  # Active when COMP_OUT streams conversion results
  - name: fifo
    type: bram_fifo
    interface: intf
    base_addr: 0x8000
    base_data_addr: 0x80000000

  # Sequencer for ADC timing signals
  # Generates: CLK_INIT, CLK_SAMP, CLK_COMP, CLK_LOGIC, CLK_COMP_CAP, SEN_COMP
  # Output directly drives LVDS transmitters to chip
  - name: seq
    type: seq_gen
    interface: intf
    base_addr: 0x10000
    mem_size: 8192

  # SPI master for chip configuration
  # directly from obelix1
  # Directly drives SPI_CS_B, SPI_SCLK, SPI_SDI; reads SPI_SDO
  - name: spi
    type: spi
    interface: intf
    base_addr: 0x20000

  # GPIO for auxiliary control signals
  # Controls PCB-level discrete signals
  # Bit mapping:
  #   Bit 0: RST_B   - Chip reset (active low)
  #   Bit 1: AMP_EN  - Input amplifier enable (high=enabled, low=bypass/power-down)
  - name: gpio
    type: gpio
    interface: intf
    base_addr: 0x30000
    size: 8

  # Pulse generator for triggering sequences
  # Can trigger seq_gen externally for precise timing
  - name: pulse_gen
    type: pulse_gen
    interface: intf
    base_addr: 0x40000

  # Fast SPI receiver for COMP_OUT capture
  # Replaces hand-rolled shift register + FIFO
  # SCLK driven by seq_out[4] (CLK_COMP_CAP)
  # SEN driven by seq_out[5] (SEN_COMP)
  # SDI connected to COMP_OUT from chip
  - name: fast_spi_rx
    type: fast_spi_rx
    interface: intf
    base_addr: 0x50000

registers:
  # Track register for sequencer waveforms
  # 8 tracks for LVDS clock pairs and COMP_OUT capture control
  - name: SEQ
    type: TrackRegister
    hw_driver: seq
    seq_width: 8
    seq_size: 8192
    tracks:
      # Tracks 0-3: LVDS clock outputs to chip
      - name: CLK_INIT
        position: 0
      - name: CLK_SAMP
        position: 1
      - name: CLK_COMP
        position: 2
      - name: CLK_LOGIC
        position: 3
      # Tracks 4-5: COMP_OUT capture control (directly connected to fast_spi_rx)
      # CLK_COMP_CAP: Capture clock for sampling COMP_OUT
      #   - Connected to fast_spi_rx SCLK input
      #   - Sequencer track allows adjusting sample edge to compensate for
      #     round-trip propagation delay (FPGA → LVDS → chip → comparator → LVDS → FPGA)
      - name: CLK_COMP_CAP
        position: 4
      # SEN_COMP: Frame enable for COMP_OUT capture
      #   - Connected to fast_spi_rx SEN input
      #   - High during the 17 comparator bit capture cycles
      #   - Falling edge triggers partial word flush in fast_spi_rx
      - name: SEN_COMP
        position: 5
      # Reserved for future use
      - name: SPARE_6
        position: 6
      - name: SPARE_7
        position: 7
